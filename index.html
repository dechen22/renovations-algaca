<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alga√ßa Renovation Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #a8e6cf 0%, #dcedc1 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 16px;
            padding: 12px 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        h1 {
            color: #5a9f7e;
            font-size: 1.25rem;
            margin-bottom: 0;
        }
        
        .subtitle {
            color: #666;
            font-size: 1rem;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #5a9f7e;
            color: white;
        }
        
        .btn-primary:hover {
            background: #4a8f6e;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(90, 159, 126, 0.4);
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-success:hover {
            background: #38a169;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .btn-secondary:hover {
            background: #cbd5e0;
        }
        
        .file-input {
            display: none;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .stat-label {
            color: #718096;
            font-size: 12px;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-value {
            color: #2d3748;
            font-size: 24px;
            font-weight: 600;
        }
        
        .stat-sub {
            color: #a0aec0;
            font-size: 12px;
            margin-top: 4px;
        }
        
        .progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            margin-top: 12px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #5a9f7e, #7bc59c);
            transition: width 0.3s;
        }
        
        .main-content {
            display: block;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 768px) {
            .card {
                padding: 16px;
                border-radius: 8px;
            }
        }
        
        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            color: #4a5568;
            font-weight: 500;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            transition: border-color 0.3s;
        }
        
        #categoryFilter {
            background: #5a9f7e;
            color: white;
            border: none;
            font-weight: 600;
            cursor: pointer;
            padding: 12px 16px;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }
        
        #categoryFilter:hover {
            background: #4a8f6e;
        }
        
        #categoryFilter option {
            background: white;
            color: #2d3748;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #5a9f7e;
        }
        
        input[type="file"] {
            border: 2px dashed #e2e8f0;
            padding: 20px;
            background: #f7fafc;
            cursor: pointer;
            position: relative;
        }
        
        input[type="file"]:hover {
            border-color: #5a9f7e;
            background: #edf2f7;
        }
        
        input[type="file"]::file-selector-button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: #5a9f7e;
            color: white;
            font-weight: 600;
            cursor: pointer;
            margin-right: 12px;
            transition: background 0.2s;
        }
        
        input[type="file"]::file-selector-button:hover {
            background: #4a8f6e;
        }
        
        textarea {
            resize: vertical;
            min-height: 40px;
            max-height: 120px;
        }
        
        @media (max-width: 768px) {
            input, select, textarea {
                padding: 8px 6px;
                font-size: 16px;
            }
            
            input[type="date"] {
                padding: 8px 4px;
                font-size: 14px;
            }
            
            .modal-body {
                padding: 16px;
            }
        }
        
        .category-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            table-layout: fixed;
        }
        
        .category-table th,
        .category-table td {
            word-wrap: break-word;
        }
        
        .category-table th:first-child,
        .category-table td:first-child {
            width: 50%;
        }
        
        .category-table th:nth-child(2),
        .category-table td:nth-child(2),
        .category-table th:nth-child(3),
        .category-table td:nth-child(3) {
            width: 25%;
            text-align: right;
            white-space: nowrap;
        }
        
        @media (max-width: 768px) {
            .category-table th,
            .category-table td {
                font-size: 13px;
                padding: 10px 6px;
            }
            
            .category-table th:first-child,
            .category-table td:first-child {
                width: 45%;
            }
            
            .category-table th:nth-child(2),
            .category-table td:nth-child(2),
            .category-table th:nth-child(3),
            .category-table td:nth-child(3) {
                width: 27.5%;
                white-space: nowrap;
            }
        }
        
        .category-table th {
            background: #f7fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            font-size: 13px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .category-table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
        }
        
        .category-table tr:hover {
            background: #f7fafc;
        }
        
        .category-table .total-row {
            background: #5a9f7e;
            color: white;
            font-weight: 600;
            font-size: 15px;
        }
        
        .category-table .total-row:hover {
            background: #5a9f7e;
        }
        
        .category-table .total-row td {
            border-bottom: none;
            padding: 14px 12px;
        }
        
        .amount {
            font-weight: 500;
        }
        
        .positive {
            color: #48bb78;
        }
        
        .negative {
            color: #f56565;
        }
        
        .payment-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .payment-item {
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            transition: background 0.2s;
        }
        
        .payment-item:hover {
            background: #f7fafc;
        }
        
        .payment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .payment-meta {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .payment-category {
            font-weight: 500;
            color: #2d3748;
            font-size: 14px;
        }
        
        .payment-amount {
            font-weight: 600;
            color: #5a9f7e;
            font-size: 16px;
        }
        
        .payment-date {
            color: #718096;
            font-size: 13px;
        }
        
        .payment-notes {
            color: #4a5568;
            font-size: 13px;
        }
        
        .receipt-link {
            color: #5a9f7e;
            text-decoration: none;
            font-size: 12px;
            display: inline-block;
            margin-top: 4px;
            font-weight: 600;
        }
        
        .receipt-link:hover {
            text-decoration: underline;
            color: #4a8f6e;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #a0aec0;
        }
        
        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .badge-success {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .badge-warning {
            background: #fef5e7;
            color: #7c2d12;
        }
        
        .badge-danger {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .icon {
            width: 20px;
            height: 20px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s;
        }
        
        @media (max-width: 768px) {
            .modal-content {
                margin: 2% auto;
                width: 95%;
                max-height: 90vh;
            }
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: #2d3748;
        }
        
        .close {
            color: #a0aec0;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
            line-height: 1;
        }
        
        .close:hover,
        .close:focus {
            color: #4a5568;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .add-btn {
            padding: 10px 20px;
            background: #5a9f7e;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .add-btn:hover {
            background: #4a8f6e;
            transform: translateY(-2px);
        }
        
        @media (max-width: 768px) {
            .add-new-invoice-container {
                margin: 15px 0 !important;
            }
        }
        
        .delete-btn {
            padding: 10px 20px;
            background: #f56565;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .delete-btn:hover {
            background: #e53e3e;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† Alga√ßa Renovation</h1>
            
            <div class="controls" style="display: none;">
            </div>
        </div>
        
        <div class="add-new-invoice-container" style="text-align: center; margin: 30px 0;">
            <button class="add-btn" onclick="openModal()">
                <span style="color: white; font-weight: bold; font-size: 18px;">+</span> Add New Invoice
            </button>
        </div>
        
        <div class="card">
            <h2 class="card-title">
                üìä Budget vs Paid
            </h2>
            <div id="categoryBreakdown"></div>
        </div>
        
        <div style="margin-top: 30px;"></div>
        
        <!-- Modal -->
        <div id="invoiceModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><span style="color: #48bb78; font-weight: bold; font-size: 24px;">+</span> Add New Invoice</h2>
                    <span class="close" onclick="closeModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="invoiceForm">
                        <div class="form-group">
                            <label for="category">Category</label>
                            <select id="category" required>
                                <option value="">Select category...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="date">Date</label>
                            <input type="date" id="date" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="amount">Amount (‚Ç¨)</label>
                            <input type="number" id="amount" step="0.01" required placeholder="0.00">
                        </div>
                        
                        <div class="form-group">
                            <label for="notes">Notes</label>
                            <textarea id="notes" placeholder="Add description or details..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="receipt">Receipt (optional)</label>
                            <input type="file" id="receipt" accept="image/*,.pdf">
                        </div>
                        
                        <button type="submit" class="btn btn-primary" style="width: auto; padding: 8px 16px; font-size: 14px;">
                            Save
                        </button>
                        <button type="button" class="delete-btn" id="deleteBtn" style="display: none;" onclick="deletePayment()">
                            üóëÔ∏è Delete Payment
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="card">
                <h2 class="card-title">
                    üìã Payment History
                </h2>
                <div class="form-group" style="margin-bottom: 20px;">
                    <select id="categoryFilter" onchange="setFilter(this.value)">
                        <option value="All">All Categories</option>
                    </select>
                </div>
                <div class="payment-list" id="paymentList"></div>
            </div>
        </div>
        
        <div style="margin-top: 40px;"></div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Remaining</div>
                <div class="stat-value" id="remaining">‚Ç¨0</div>
                <div class="stat-sub" id="remainingSub">Budget left</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">Status</div>
                <div class="stat-value" id="statusPercent">0%</div>
                <div class="stat-sub">Budget used</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Pre-loaded data from Excel file
        const initialData = {"budget":{"Builder":{"planned":22900,"spent":0},"Carpentry":{"planned":2000,"spent":0},"Digger - Garden":{"planned":2500,"spent":0},"Plumber":{"planned":2500,"spent":0},"Electricity":{"planned":8500,"spent":0},"Rita Salary":{"planned":3500,"spent":0},"Miscellaneous":{"planned":4500,"spent":0},"New kitchen":{"planned":4000,"spent":0},"Roof":{"planned":7000,"spent":0}},"payments":[{"category":"Rita Salary","date":"2025-03-21","amount":160,"notes":"Plans","receipt":"https://drive.google.com/file/d/182IO-ALBJrs2eOWawtlo7SiSNnikJKRD/view?usp=drive_link"},{"category":"Rita Salary","date":"2025-05-01","amount":207.8,"notes":"First bill","receipt":"https://drive.google.com/file/d/1e3CHYo5dKUHyykT6aQNZ0JvPbVwAfQul/view?usp=drive_link"},{"category":"Miscellaneous","date":"2025-05-16","amount":35.44,"notes":"Imposto Certidao","receipt":"https://drive.google.com/file/d/1hlvOWI_zRay1_6RBqcORcwyixK_WnkZc/view?usp=drive_link"},{"category":"Rita Salary","date":"2025-07-01","amount":345.2,"notes":"July payment","receipt":""},{"category":"Digger - Garden","date":"2025-09-01","amount":48,"notes":"Trimming (Rita's son)","receipt":""},{"category":"Electricity","date":"2025-10-13","amount":400,"notes":"Generator","receipt":""},{"category":"Plumber","date":"2025-10-24","amount":641.14,"notes":"Materials","receipt":"https://drive.google.com/file/d/1IGujTa-hpPHrog44FUl3Cj8AMVZ8cDJg/view?usp=drive_link"},{"category":"Rita Salary","date":"2025-10-25","amount":480,"notes":"October","receipt":""},{"category":"Rita Salary","date":"2025-10-25","amount":63,"notes":"10 trips X 14 km","receipt":""},{"category":"Builder","date":"2025-10-25","amount":1800,"notes":"3 weeks  Zeca","receipt":""},{"category":"Digger - Garden","date":"2025-10-25","amount":80,"notes":"Prune trees ","receipt":""},{"category":"Electricity","date":"2025-10-25","amount":40.49,"notes":"Fuel Generator","receipt":""},{"category":"Miscellaneous","date":"2025-10-25","amount":28.6,"notes":"Fence ","receipt":""},{"category":"Builder","date":"2025-11-02","amount":480,"notes":"Farley (assist) 6 days","receipt":""},{"category":"Plumber","date":"2025-11-06","amount":477.2,"notes":"Paulo work","receipt":"https://drive.google.com/file/d/16mOUOAxEFKDG1rVB0k8KD4059o8XwNKj/view?usp=drive_link"},{"category":"Digger - Garden","date":"2025-11-24","amount":1660,"notes":"FLN","receipt":"https://drive.google.com/file/d/1hEt38HZcZ5WUJtEReB3uKFkjocr0YOPa/view?usp=drive_link"},{"category":"Builder","date":"2025-12-25","amount":480,"notes":"Zeca  ","receipt":""},{"category":"Builder","date":"2025-12-25","amount":829.92,"notes":"Material Construcao","receipt":"https://drive.google.com/file/d/1a8lVYUc4H7WTDbUqUZrw32y7M5Yabdzh/view?usp=sharing"},{"category":"Builder","date":"2025-12-27","amount":600,"notes":"Zeca  ","receipt":""},{"category":"Builder","date":"2026-01-02","amount":480,"notes":"Zeca  ","receipt":""},{"category":"Builder","date":"2026-01-02","amount":160,"notes":"Farley ","receipt":""},{"category":"Builder","date":"2026-01-04","amount":80,"notes":"Farley","receipt":""},{"category":"Builder","date":"2026-01-09","amount":600,"notes":"Zeca  ","receipt":""},{"category":"Builder","date":"2026-01-09","amount":420,"notes":"Farley","receipt":""},{"category":"Electricity","date":"2026-01-09","amount":64,"notes":"Fuel Generator","receipt":""},{"category":"Electricity","date":"28.12.25","amount":1000,"notes":"Mathew start","receipt":""},{"category":"Builder","date":"2026-01-17","amount":356,"notes":"Material","receipt":""},{"category":"Builder","date":"2026-01-17","amount":600,"notes":"Week Zeca","receipt":""},{"category":"Builder","date":"2026-01-17","amount":19.61,"notes":"Materials for windows surround","receipt":""},{"category":"Builder","date":"2026-01-17","amount":200,"notes":"2.5 Days Farley","receipt":""},{"category":"Rita Salary","date":"2026-01-22","amount":356,"notes":"November","receipt":"https://drive.google.com/file/d/1gZVYPEMYmRDWUgnimdBct04Nn0vUAsDg/view?usp=drive_link"},{"category":"Rita Salary","date":"2026-01-22","amount":561,"notes":"December","receipt":"https://drive.google.com/file/d/1oJ42ix2twiaBxbbNnAakWjcVXB8yL8do/view?usp=drive_link"},{"category":"Builder","date":"2026-01-22","amount":600,"notes":"Zeca Week","receipt":""},{"category":"Builder","date":"2026-01-22","amount":200,"notes":"2.5 days Farley","receipt":""},{"category":"Plumber","date":"2026-01-22","amount":31.32,"notes":"Water Apin","receipt":""}]};
        
        // Google Sheets URL
        const SHEETS_URL = 'https://script.google.com/macros/s/AKfycbyhCkq5pqT3iocP6xFN4YPUaI_ToUQwK_lvDB1LScYpJt2AInb3KB5Gk2mOlECdPRvcNg/exec';
        
        let budgetData = {};
        let payments = [];
        let activeFilter = 'All';
        let loadResolve;
        let editingIndex = -1; // Track if we're editing an existing payment
        
        // Global callback for JSONP
        window.handleSheetData = function(data) {
            console.log('‚úì Successfully received data from Google Sheets');
            console.log('Budget categories:', Object.keys(data.budget));
            console.log('Number of payments:', data.payments.length);
            
            budgetData = data.budget;
            payments = data.payments;
            
            // Calculate spent amounts from payments
            Object.keys(budgetData).forEach(cat => budgetData[cat].spent = 0);
            payments.forEach(payment => {
                if (budgetData[payment.category]) {
                    budgetData[payment.category].spent += payment.amount;
                } else {
                    budgetData[payment.category] = {
                        planned: 0,
                        spent: payment.amount
                    };
                }
            });
            
            // Sort payments by date (newest first)
            payments.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (loadResolve) {
                console.log('‚úì Data processing complete, updating UI...');
                loadResolve();
            }
        };
        
        // Load from Google Sheets using JSONP
        async function loadData() {
            return new Promise((resolve) => {
                loadResolve = resolve;
                
                console.log('Starting to load data from Google Sheets...');
                console.log('URL:', SHEETS_URL);
                
                const script = document.createElement('script');
                const callbackParam = 'handleSheetData';
                const timestamp = new Date().getTime();
                script.src = SHEETS_URL + '?callback=' + callbackParam + '&t=' + timestamp;
                
                console.log('Full URL:', script.src);
                
                script.onload = function() {
                    console.log('‚úì Script loaded successfully');
                };
                
                script.onerror = function(e) {
                    console.error('‚úó Script loading failed');
                    console.error('Error event:', e);
                    console.log('Using initial/fallback data instead');
                    
                    budgetData = JSON.parse(JSON.stringify(initialData.budget));
                    payments = JSON.parse(JSON.stringify(initialData.payments));
                    
                    // Calculate spent amounts from payments
                    payments.forEach(payment => {
                        if (budgetData[payment.category]) {
                            budgetData[payment.category].spent += payment.amount;
                        } else {
                            budgetData[payment.category] = {
                                planned: 0,
                                spent: payment.amount
                            };
                        }
                    });
                    
                    payments.sort((a, b) => new Date(b.date) - new Date(a.date));
                    resolve();
                };
                
                console.log('Appending script to document head...');
                document.head.appendChild(script);
                
                // Timeout fallback
                setTimeout(() => {
                    if (Object.keys(budgetData).length === 0) {
                        console.warn('‚ö† Timeout (5s) - Google Sheets did not respond');
                        console.log('Using initial/fallback data instead');
                        
                        budgetData = JSON.parse(JSON.stringify(initialData.budget));
                        payments = JSON.parse(JSON.stringify(initialData.payments));
                        
                        payments.forEach(payment => {
                            if (budgetData[payment.category]) {
                                budgetData[payment.category].spent += payment.amount;
                            }
                        });
                        
                        payments.sort((a, b) => new Date(b.date) - new Date(a.date));
                        resolve();
                    }
                }, 5000);
            });
        }
        
        // Save to Google Sheets
        async function saveData() {
            try {
                await fetch(SHEETS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        payments: payments
                    })
                });
                console.log('Data saved to Google Sheets');
            } catch (error) {
                console.error('Error saving to Google Sheets:', error);
            }
        }
        
        // Initialize
        loadData().then(() => {
            document.getElementById('date').valueAsDate = new Date();
            updateUI();
        });
        
        // Modal functions
        function openModal() {
            editingIndex = -1;
            document.getElementById('invoiceForm').reset();
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('deleteBtn').style.display = 'none';
            document.getElementById('invoiceModal').style.display = 'block';
        }
        
        function openEditModal(index) {
            editingIndex = index;
            const payment = payments[index];
            
            document.getElementById('category').value = payment.category;
            
            // Handle date formatting - need YYYY-MM-DD for input[type="date"]
            let dateValue = '';
            if (payment.date) {
                try {
                    // Try to parse the date
                    let parsedDate;
                    
                    // Check if it's already in YYYY-MM-DD format
                    if (/^\d{4}-\d{2}-\d{2}$/.test(payment.date)) {
                        dateValue = payment.date;
                    } else {
                        // Try to parse as a date object
                        parsedDate = new Date(payment.date);
                        
                        // Check if valid date
                        if (!isNaN(parsedDate.getTime())) {
                            // Format as YYYY-MM-DD
                            const year = parsedDate.getFullYear();
                            const month = String(parsedDate.getMonth() + 1).padStart(2, '0');
                            const day = String(parsedDate.getDate()).padStart(2, '0');
                            dateValue = `${year}-${month}-${day}`;
                        }
                    }
                } catch (e) {
                    console.error('Error parsing date:', e);
                    dateValue = '';
                }
            }
            
            document.getElementById('date').value = dateValue;
            document.getElementById('amount').value = payment.amount;
            document.getElementById('notes').value = payment.notes || '';
            
            // Handle receipt - if it's a file object, show filename; if it's a link, can't pre-fill file input
            // Note: File inputs can't be pre-filled for security reasons
            
            document.getElementById('deleteBtn').style.display = 'inline-block';
            document.getElementById('invoiceModal').style.display = 'block';
        }
        
        function closeModal() {
            editingIndex = -1;
            document.getElementById('invoiceModal').style.display = 'none';
        }
        
        function deletePayment() {
            if (confirm('Are you sure you want to delete this payment? This cannot be undone.')) {
                const payment = payments[editingIndex];
                
                // Remove from spent
                if (budgetData[payment.category]) {
                    budgetData[payment.category].spent -= payment.amount;
                }
                
                // Remove from payments array
                payments.splice(editingIndex, 1);
                
                // Save and update
                saveData();
                closeModal();
                updateUI();
            }
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('invoiceModal');
            if (event.target == modal) {
                closeModal();
            }
        }
        
        // Invoice form submission
        document.getElementById('invoiceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const receiptFile = document.getElementById('receipt').files[0];
            let receiptData = '';
            
            // If there's a file, convert to base64
            if (receiptFile) {
                receiptData = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve({
                        name: receiptFile.name,
                        type: receiptFile.type,
                        data: e.target.result
                    });
                    reader.onerror = reject;
                    reader.readAsDataURL(receiptFile);
                });
            }
            
            const paymentData = {
                category: document.getElementById('category').value,
                date: document.getElementById('date').value,
                amount: parseFloat(document.getElementById('amount').value),
                notes: document.getElementById('notes').value,
                receipt: receiptData
            };
            
            if (editingIndex >= 0) {
                // Editing existing payment
                const oldPayment = payments[editingIndex];
                
                // Update spent amounts
                if (budgetData[oldPayment.category]) {
                    budgetData[oldPayment.category].spent -= oldPayment.amount;
                }
                
                // If no new file was uploaded, keep the old receipt
                if (!receiptFile && oldPayment.receipt) {
                    paymentData.receipt = oldPayment.receipt;
                }
                
                payments[editingIndex] = paymentData;
                
                if (budgetData[paymentData.category]) {
                    budgetData[paymentData.category].spent += paymentData.amount;
                } else {
                    budgetData[paymentData.category] = {
                        planned: 0,
                        spent: paymentData.amount
                    };
                }
            } else {
                // Adding new payment
                payments.unshift(paymentData);
                
                if (budgetData[paymentData.category]) {
                    budgetData[paymentData.category].spent += paymentData.amount;
                } else {
                    budgetData[paymentData.category] = {
                        planned: 0,
                        spent: paymentData.amount
                    };
                }
            }
            
            // Save to localStorage
            saveData();
            
            // Reset form and close modal
            this.reset();
            document.getElementById('date').valueAsDate = new Date();
            closeModal();
            
            updateUI();
        });
        
        function updateUI() {
            updateStats();
            updateCategorySelect();
            updateCategoryFilters();
            updateCategoryBreakdown();
            updatePaymentList();
        }
        
        function updateStats() {
            const totalBudget = Object.values(budgetData).reduce((sum, cat) => sum + cat.planned, 0);
            const totalSpent = Object.values(budgetData).reduce((sum, cat) => sum + cat.spent, 0);
            const remaining = totalBudget - totalSpent;
            const percentage = totalBudget > 0 ? (totalSpent / totalBudget * 100) : 0;
            
            document.getElementById('remaining').textContent = '‚Ç¨' + remaining.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
            document.getElementById('statusPercent').textContent = percentage.toFixed(1) + '%';
            
            document.getElementById('remainingSub').textContent = remaining >= 0 ? 'Budget left' : 'Over budget';
            document.getElementById('progressFill').style.width = Math.min(percentage, 100) + '%';
            
            // Color coding for remaining and status percent
            const remainingEl = document.getElementById('remaining');
            const statusPercentEl = document.getElementById('statusPercent');
            const color = remaining >= 0 ? '#48bb78' : '#f56565';
            remainingEl.style.color = color;
            statusPercentEl.style.color = color;
        }
        
        function updateCategorySelect() {
            const select = document.getElementById('category');
            select.innerHTML = '<option value="">Select category...</option>';
            
            Object.keys(budgetData).sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
        }
        
        function updateCategoryFilters() {
            const select = document.getElementById('categoryFilter');
            const categories = Object.keys(budgetData).sort();
            
            select.innerHTML = '<option value="All">All Categories</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                if (category === activeFilter) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }
        
        function setFilter(category) {
            activeFilter = category;
            updatePaymentList();
        }
        
        function updateCategoryBreakdown() {
            const container = document.getElementById('categoryBreakdown');
            
            // Define the desired order
            const categoryOrder = [
                'Rita Salary',
                'Plumber',
                'Digger - Garden',
                'Miscellaneous',
                'Builder',
                'Carpentry',
                'Electricity',
                'New kitchen',
                'Roof'
            ];
            
            let html = '<table class="category-table"><thead><tr><th>Category</th><th>Budget</th><th>Paid</th></tr></thead><tbody>';
            
            let totalPlanned = 0;
            let totalSpent = 0;
            
            // Display categories in the specified order
            categoryOrder.forEach(category => {
                if (budgetData[category]) {
                    const data = budgetData[category];
                    totalPlanned += data.planned;
                    totalSpent += data.spent;
                    
                    html += `
                        <tr>
                            <td style="font-weight: 600;">${category}</td>
                            <td class="amount">‚Ç¨${data.planned.toLocaleString()}</td>
                            <td class="amount ${data.spent > 0 ? 'negative' : ''}">‚Ç¨${Math.round(data.spent).toLocaleString()}</td>
                        </tr>
                    `;
                }
            });
            
            // Add any categories not in the order list (in case new ones are added)
            Object.entries(budgetData).forEach(([category, data]) => {
                if (!categoryOrder.includes(category)) {
                    totalPlanned += data.planned;
                    totalSpent += data.spent;
                    
                    html += `
                        <tr>
                            <td style="font-weight: 600;">${category}</td>
                            <td class="amount">‚Ç¨${data.planned.toLocaleString()}</td>
                            <td class="amount ${data.spent > 0 ? 'negative' : ''}">‚Ç¨${Math.round(data.spent).toLocaleString()}</td>
                        </tr>
                    `;
                }
            });
            
            // Add total row
            html += `
                <tr class="total-row">
                    <td>Total</td>
                    <td>‚Ç¨${totalPlanned.toLocaleString()}</td>
                    <td>‚Ç¨${Math.round(totalSpent).toLocaleString()}</td>
                </tr>
            `;
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function updatePaymentList() {
            const container = document.getElementById('paymentList');
            
            // Filter payments based on active filter
            const filteredPayments = activeFilter === 'All' 
                ? payments 
                : payments.filter(p => p.category === activeFilter);
            
            let html = '';
            filteredPayments.forEach((payment, filteredIndex) => {
                // Find the actual index in the full payments array
                const actualIndex = payments.indexOf(payment);
                const date = new Date(payment.date);
                const formattedDate = date.toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'});
                
                // Handle receipt - could be uploaded file or link
                let receiptHtml = '';
                if (payment.receipt) {
                    if (typeof payment.receipt === 'object' && payment.receipt.data) {
                        // It's an uploaded file
                        receiptHtml = `<a href="${payment.receipt.data}" download="${payment.receipt.name}" class="receipt-link">üìé ${payment.receipt.name}</a>`;
                    } else if (typeof payment.receipt === 'string' && payment.receipt.startsWith('http')) {
                        // It's a link (old data)
                        receiptHtml = `<a href="${payment.receipt}" target="_blank" class="receipt-link">üìé View Receipt</a>`;
                    }
                }
                
                html += `
                    <div class="payment-item" onclick="openEditModal(${actualIndex})" style="cursor: pointer;">
                        <div class="payment-header">
                            <div class="payment-meta">
                                <div class="payment-category">${payment.category}</div>
                                <div class="payment-date">${formattedDate}</div>
                            </div>
                            <div class="payment-amount">‚Ç¨${payment.amount.toLocaleString()}</div>
                        </div>
                        ${payment.notes ? `<div class="payment-notes">${payment.notes}</div>` : ''}
                        ${receiptHtml}
                    </div>
                `;
            });
            
            container.innerHTML = html || '<div class="empty-state"><p>No payments in this category</p></div>';
        }
        
    </script>
</body>
</html>
